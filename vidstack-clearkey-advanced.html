<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidstack ClearKey é«˜çº§ç¤ºä¾‹</title>
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css">
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        #player {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
        
        .config-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Vidstack Player - ClearKey DRM é«˜çº§ç¤ºä¾‹</h1>
        
        <div class="config-section">
            <h2>ğŸ“ é…ç½®å‚æ•°</h2>
            
            <div class="input-group">
                <label for="mpdUrl">MPD æµåœ°å€:</label>
                <input type="url" id="mpdUrl" value="https://qp-pldt-live-grp-05-prod.akamaized.net/out/u/cg_spotvhd.mpd">
            </div>
            
            <div class="input-group">
                <label for="keyId">Key ID (32ä½åå…­è¿›åˆ¶):</label>
                <input type="text" id="keyId" value="ec7ee27d83764e4b845c48cca31c8eef" maxlength="32">
            </div>
            
            <div class="input-group">
                <label for="keyValue">Key (32ä½åå…­è¿›åˆ¶):</label>
                <input type="text" id="keyValue" value="9c0e4191203fccb0fde34ee29999129e" maxlength="32">
            </div>
            
            <div class="input-group">
                <label for="streamType">æµç±»å‹:</label>
                <select id="streamType" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                    <option value="live">ç›´æ’­æµ (live)</option>
                    <option value="on-demand">ç‚¹æ’­æµ (on-demand)</option>
                    <option value="ll-live">ä½å»¶è¿Ÿç›´æ’­ (ll-live)</option>
                </select>
            </div>
            
            <button onclick="updatePlayer()">ğŸ”„ æ›´æ–°æ’­æ”¾å™¨</button>
            <button onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
        </div>

        <div id="player"></div>
        
        <div class="config-section">
            <h2>ğŸ® æ’­æ”¾æ§åˆ¶</h2>
            <button onclick="playVideo()">â–¶ï¸ æ’­æ”¾</button>
            <button onclick="pauseVideo()">â¸ï¸ æš‚åœ</button>
            <button onclick="stopVideo()">â¹ï¸ åœæ­¢</button>
            <button onclick="muteVideo()">ğŸ”‡ é™éŸ³/å–æ¶ˆé™éŸ³</button>
            <button onclick="getPlayerInfo()">ğŸ“Š è·å–æ’­æ”¾å™¨ä¿¡æ¯</button>
            <button onclick="clearConsole()">ğŸ—‘ï¸ æ¸…é™¤æ§åˆ¶å°</button>
        </div>
        
        <div class="config-section">
            <h2>ğŸ“Š æ’­æ”¾çŠ¶æ€</h2>
            <div id="status" class="status info">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>
        
        <div class="config-section">
            <h2>ğŸ–¥ï¸ æ§åˆ¶å°è¾“å‡º</h2>
            <div id="console"></div>
        </div>
    </div>

    <script type="module">
        import { VidstackPlayer, VidstackPlayerLayout } from 'https://cdn.vidstack.io/player.core';

        let player = null;
        let isPlayerReady = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }

        async function createPlayer() {
            try {
                const mpdUrl = document.getElementById('mpdUrl').value;
                const keyId = document.getElementById('keyId').value;
                const keyValue = document.getElementById('keyValue').value;
                const streamType = document.getElementById('streamType').value;

                if (!mpdUrl || !keyId || !keyValue) {
                    throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€çš„å‚æ•°');
                }

                logToConsole('å¼€å§‹åˆ›å»ºæ’­æ”¾å™¨...', 'info');
                updateStatus('æ­£åœ¨åˆå§‹åŒ–æ’­æ”¾å™¨...', 'info');

                // é”€æ¯ç°æœ‰æ’­æ”¾å™¨
                if (player) {
                    player.destroy();
                    player = null;
                    isPlayerReady = false;
                }

                const layout = new VidstackPlayerLayout({
                    // å¯ä»¥æ·»åŠ è‡ªå®šä¹‰å¸ƒå±€é…ç½®
                });

                // åˆ›å»º ClearKey é…ç½®
                const drmConfig = {
                    clearkey: {
                        keys: {
                            [keyId]: keyValue
                        }
                    }
                };

                logToConsole(`é…ç½® DRM: KeyID=${keyId}, Key=${keyValue}`, 'info');

                player = await VidstackPlayer.create({
                    target: '#player',
                    viewType: 'video',
                    streamType: streamType,
                    logLevel: 'warn',
                    crossOrigin: true,
                    playsInline: true,
                    muted: true,
                    title: 'ClearKey DRM æ’­æ”¾æµ‹è¯•',
                    src: mpdUrl,
                    layout,
                    drm: drmConfig,
                    autoPlay: false,
                    load: 'eager',
                    storage: null,
                    preferNativeHLS: false
                });

                setupEventListeners();
                logToConsole('æ’­æ”¾å™¨åˆ›å»ºæˆåŠŸ', 'success');
                updateStatus('æ’­æ”¾å™¨å·²å°±ç»ª', 'success');

            } catch (error) {
                logToConsole(`æ’­æ”¾å™¨åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                updateStatus(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                console.error('æ’­æ”¾å™¨åˆ›å»ºé”™è¯¯:', error);
            }
        }

        function setupEventListeners() {
            if (!player) return;

            // åª’ä½“åŠ è½½äº‹ä»¶
            player.addEventListener('loadstart', () => {
                logToConsole('å¼€å§‹åŠ è½½åª’ä½“', 'info');
                updateStatus('æ­£åœ¨åŠ è½½åª’ä½“...', 'info');
            });

            player.addEventListener('loadedmetadata', () => {
                logToConsole('åª’ä½“å…ƒæ•°æ®å·²åŠ è½½', 'success');
                updateStatus('åª’ä½“å…ƒæ•°æ®å·²åŠ è½½', 'info');
            });

            player.addEventListener('loadeddata', () => {
                logToConsole('åª’ä½“æ•°æ®å·²åŠ è½½', 'success');
            });

            player.addEventListener('canplay', () => {
                logToConsole('åª’ä½“å¯ä»¥å¼€å§‹æ’­æ”¾', 'success');
                updateStatus('åª’ä½“å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾', 'success');
                isPlayerReady = true;
            });

            player.addEventListener('canplaythrough', () => {
                logToConsole('åª’ä½“å¯ä»¥æµç•…æ’­æ”¾', 'success');
            });

            // æ’­æ”¾çŠ¶æ€äº‹ä»¶
            player.addEventListener('play', () => {
                logToConsole('æ’­æ”¾å¼€å§‹', 'success');
                updateStatus('æ­£åœ¨æ’­æ”¾', 'success');
            });

            player.addEventListener('playing', () => {
                logToConsole('æ’­æ”¾ä¸­', 'success');
                updateStatus('æ’­æ”¾ä¸­', 'success');
            });

            player.addEventListener('pause', () => {
                logToConsole('æ’­æ”¾æš‚åœ', 'info');
                updateStatus('å·²æš‚åœ', 'info');
            });

            player.addEventListener('ended', () => {
                logToConsole('æ’­æ”¾ç»“æŸ', 'info');
                updateStatus('æ’­æ”¾ç»“æŸ', 'info');
            });

            player.addEventListener('waiting', () => {
                logToConsole('ç­‰å¾…æ•°æ®ç¼“å†²...', 'info');
                updateStatus('ç¼“å†²ä¸­...', 'info');
            });

            player.addEventListener('stalled', () => {
                logToConsole('æ’­æ”¾åœæ»', 'error');
                updateStatus('æ’­æ”¾åœæ»', 'error');
            });

            // DRM å’ŒåŠ å¯†ç›¸å…³äº‹ä»¶
            player.addEventListener('encrypted', (e) => {
                logToConsole('æ£€æµ‹åˆ°åŠ å¯†åª’ä½“ï¼Œæ­£åœ¨å¤„ç† DRM...', 'info');
                updateStatus('å¤„ç† DRM åŠ å¯†...', 'info');
                console.log('åŠ å¯†è¯¦æƒ…:', e.detail);
            });

            // é”™è¯¯å¤„ç†
            player.addEventListener('error', (e) => {
                const errorMsg = e.detail.message || e.detail || 'æœªçŸ¥é”™è¯¯';
                logToConsole(`æ’­æ”¾å™¨é”™è¯¯: ${errorMsg}`, 'error');
                updateStatus(`æ’­æ”¾é”™è¯¯: ${errorMsg}`, 'error');
                console.error('æ’­æ”¾å™¨é”™è¯¯è¯¦æƒ…:', e.detail);
                isPlayerReady = false;
            });

            player.addEventListener('drm-error', (e) => {
                const errorMsg = e.detail.message || e.detail || 'DRM é”™è¯¯';
                logToConsole(`DRM é”™è¯¯: ${errorMsg}`, 'error');
                updateStatus(`DRM é”™è¯¯: ${errorMsg}`, 'error');
                console.error('DRM é”™è¯¯è¯¦æƒ…:', e.detail);
            });

            // å…¶ä»–æœ‰ç”¨çš„äº‹ä»¶
            player.addEventListener('source-change', (e) => {
                logToConsole('åª’ä½“æºå·²æ›´æ”¹', 'info');
                console.log('æºæ›´æ”¹è¯¦æƒ…:', e.detail);
            });

            player.addEventListener('time-update', (e) => {
                // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°æ’­æ”¾è¿›åº¦ï¼Œä½†ä¸è¦å¤ªé¢‘ç¹åœ°è®°å½•æ—¥å¿—
            });
        }

        // å…¨å±€å‡½æ•°
        window.updatePlayer = createPlayer;

        window.testConnection = async function() {
            const mpdUrl = document.getElementById('mpdUrl').value;
            if (!mpdUrl) {
                logToConsole('è¯·è¾“å…¥ MPD URL', 'error');
                return;
            }

            try {
                logToConsole(`æµ‹è¯•è¿æ¥: ${mpdUrl}`, 'info');
                updateStatus('æµ‹è¯•è¿æ¥ä¸­...', 'info');
                
                const response = await fetch(mpdUrl, { method: 'HEAD' });
                if (response.ok) {
                    logToConsole(`è¿æ¥æˆåŠŸ (${response.status})`, 'success');
                    updateStatus('è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    logToConsole(`è¿æ¥å¤±è´¥ (${response.status})`, 'error');
                    updateStatus(`è¿æ¥å¤±è´¥ (${response.status})`, 'error');
                }
            } catch (error) {
                logToConsole(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.playVideo = async function() {
            if (!player) {
                logToConsole('æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            try {
                await player.play();
                logToConsole('æ’­æ”¾å‘½ä»¤å·²å‘é€', 'info');
            } catch (error) {
                logToConsole(`æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.pauseVideo = function() {
            if (!player) {
                logToConsole('æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            player.pause();
            logToConsole('æš‚åœå‘½ä»¤å·²å‘é€', 'info');
        };

        window.stopVideo = function() {
            if (!player) {
                logToConsole('æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            player.pause();
            player.currentTime = 0;
            logToConsole('åœæ­¢æ’­æ”¾', 'info');
        };

        window.muteVideo = function() {
            if (!player) {
                logToConsole('æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            player.muted = !player.muted;
            logToConsole(`${player.muted ? 'å·²é™éŸ³' : 'å–æ¶ˆé™éŸ³'}`, 'info');
        };

        window.getPlayerInfo = function() {
            if (!player) {
                logToConsole('æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            const info = {
                currentTime: player.currentTime,
                duration: player.duration,
                volume: player.volume,
                muted: player.muted,
                paused: player.paused,
                ended: player.ended,
                readyState: player.readyState,
                networkState: player.networkState
            };

            logToConsole('æ’­æ”¾å™¨ä¿¡æ¯:', 'info');
            Object.entries(info).forEach(([key, value]) => {
                logToConsole(`  ${key}: ${value}`, 'info');
            });
        };

        window.clearConsole = function() {
            document.getElementById('console').textContent = '';
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('é¡µé¢åŠ è½½å®Œæˆ', 'success');
            updateStatus('é¡µé¢å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"æ›´æ–°æ’­æ”¾å™¨"å¼€å§‹', 'info');
        });
    </script>
</body>
</html>