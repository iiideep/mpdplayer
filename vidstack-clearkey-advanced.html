<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidstack ClearKey 高级示例</title>
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css">
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        #player {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
        
        .config-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 Vidstack Player - ClearKey DRM 高级示例</h1>
        
        <div class="config-section">
            <h2>📝 配置参数</h2>
            
            <div class="input-group">
                <label for="mpdUrl">MPD 流地址:</label>
                <input type="url" id="mpdUrl" value="https://qp-pldt-live-grp-05-prod.akamaized.net/out/u/cg_spotvhd.mpd">
            </div>
            
            <div class="input-group">
                <label for="keyId">Key ID (32位十六进制):</label>
                <input type="text" id="keyId" value="ec7ee27d83764e4b845c48cca31c8eef" maxlength="32">
            </div>
            
            <div class="input-group">
                <label for="keyValue">Key (32位十六进制):</label>
                <input type="text" id="keyValue" value="9c0e4191203fccb0fde34ee29999129e" maxlength="32">
            </div>
            
            <div class="input-group">
                <label for="streamType">流类型:</label>
                <select id="streamType" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                    <option value="live">直播流 (live)</option>
                    <option value="on-demand">点播流 (on-demand)</option>
                    <option value="ll-live">低延迟直播 (ll-live)</option>
                </select>
            </div>
            
            <button onclick="updatePlayer()">🔄 更新播放器</button>
            <button onclick="testConnection()">🔗 测试连接</button>
        </div>

        <div id="player"></div>
        
        <div class="config-section">
            <h2>🎮 播放控制</h2>
            <button onclick="playVideo()">▶️ 播放</button>
            <button onclick="pauseVideo()">⏸️ 暂停</button>
            <button onclick="stopVideo()">⏹️ 停止</button>
            <button onclick="muteVideo()">🔇 静音/取消静音</button>
            <button onclick="getPlayerInfo()">📊 获取播放器信息</button>
            <button onclick="clearConsole()">🗑️ 清除控制台</button>
        </div>
        
        <div class="config-section">
            <h2>📊 播放状态</h2>
            <div id="status" class="status info">等待初始化...</div>
        </div>
        
        <div class="config-section">
            <h2>🖥️ 控制台输出</h2>
            <div id="console"></div>
        </div>
    </div>

    <script type="module">
        import { VidstackPlayer, VidstackPlayerLayout } from 'https://cdn.vidstack.io/player.core';

        let player = null;
        let isPlayerReady = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }

        async function createPlayer() {
            try {
                const mpdUrl = document.getElementById('mpdUrl').value;
                const keyId = document.getElementById('keyId').value;
                const keyValue = document.getElementById('keyValue').value;
                const streamType = document.getElementById('streamType').value;

                if (!mpdUrl || !keyId || !keyValue) {
                    throw new Error('请填写所有必需的参数');
                }

                logToConsole('开始创建播放器...', 'info');
                updateStatus('正在初始化播放器...', 'info');

                // 销毁现有播放器
                if (player) {
                    player.destroy();
                    player = null;
                    isPlayerReady = false;
                }

                const layout = new VidstackPlayerLayout({
                    // 可以添加自定义布局配置
                });

                // 创建 ClearKey 配置
                const drmConfig = {
                    clearkey: {
                        keys: {
                            [keyId]: keyValue
                        }
                    }
                };

                logToConsole(`配置 DRM: KeyID=${keyId}, Key=${keyValue}`, 'info');

                player = await VidstackPlayer.create({
                    target: '#player',
                    viewType: 'video',
                    streamType: streamType,
                    logLevel: 'warn',
                    crossOrigin: true,
                    playsInline: true,
                    muted: true,
                    title: 'ClearKey DRM 播放测试',
                    src: mpdUrl,
                    layout,
                    drm: drmConfig,
                    autoPlay: false,
                    load: 'eager',
                    storage: null,
                    preferNativeHLS: false
                });

                setupEventListeners();
                logToConsole('播放器创建成功', 'success');
                updateStatus('播放器已就绪', 'success');

            } catch (error) {
                logToConsole(`播放器创建失败: ${error.message}`, 'error');
                updateStatus(`创建失败: ${error.message}`, 'error');
                console.error('播放器创建错误:', error);
            }
        }

        function setupEventListeners() {
            if (!player) return;

            // 媒体加载事件
            player.addEventListener('loadstart', () => {
                logToConsole('开始加载媒体', 'info');
                updateStatus('正在加载媒体...', 'info');
            });

            player.addEventListener('loadedmetadata', () => {
                logToConsole('媒体元数据已加载', 'success');
                updateStatus('媒体元数据已加载', 'info');
            });

            player.addEventListener('loadeddata', () => {
                logToConsole('媒体数据已加载', 'success');
            });

            player.addEventListener('canplay', () => {
                logToConsole('媒体可以开始播放', 'success');
                updateStatus('媒体已准备就绪，可以播放', 'success');
                isPlayerReady = true;
            });

            player.addEventListener('canplaythrough', () => {
                logToConsole('媒体可以流畅播放', 'success');
            });

            // 播放状态事件
            player.addEventListener('play', () => {
                logToConsole('播放开始', 'success');
                updateStatus('正在播放', 'success');
            });

            player.addEventListener('playing', () => {
                logToConsole('播放中', 'success');
                updateStatus('播放中', 'success');
            });

            player.addEventListener('pause', () => {
                logToConsole('播放暂停', 'info');
                updateStatus('已暂停', 'info');
            });

            player.addEventListener('ended', () => {
                logToConsole('播放结束', 'info');
                updateStatus('播放结束', 'info');
            });

            player.addEventListener('waiting', () => {
                logToConsole('等待数据缓冲...', 'info');
                updateStatus('缓冲中...', 'info');
            });

            player.addEventListener('stalled', () => {
                logToConsole('播放停滞', 'error');
                updateStatus('播放停滞', 'error');
            });

            // DRM 和加密相关事件
            player.addEventListener('encrypted', (e) => {
                logToConsole('检测到加密媒体，正在处理 DRM...', 'info');
                updateStatus('处理 DRM 加密...', 'info');
                console.log('加密详情:', e.detail);
            });

            // 错误处理
            player.addEventListener('error', (e) => {
                const errorMsg = e.detail.message || e.detail || '未知错误';
                logToConsole(`播放器错误: ${errorMsg}`, 'error');
                updateStatus(`播放错误: ${errorMsg}`, 'error');
                console.error('播放器错误详情:', e.detail);
                isPlayerReady = false;
            });

            player.addEventListener('drm-error', (e) => {
                const errorMsg = e.detail.message || e.detail || 'DRM 错误';
                logToConsole(`DRM 错误: ${errorMsg}`, 'error');
                updateStatus(`DRM 错误: ${errorMsg}`, 'error');
                console.error('DRM 错误详情:', e.detail);
            });

            // 其他有用的事件
            player.addEventListener('source-change', (e) => {
                logToConsole('媒体源已更改', 'info');
                console.log('源更改详情:', e.detail);
            });

            player.addEventListener('time-update', (e) => {
                // 可以在这里更新播放进度，但不要太频繁地记录日志
            });
        }

        // 全局函数
        window.updatePlayer = createPlayer;

        window.testConnection = async function() {
            const mpdUrl = document.getElementById('mpdUrl').value;
            if (!mpdUrl) {
                logToConsole('请输入 MPD URL', 'error');
                return;
            }

            try {
                logToConsole(`测试连接: ${mpdUrl}`, 'info');
                updateStatus('测试连接中...', 'info');
                
                const response = await fetch(mpdUrl, { method: 'HEAD' });
                if (response.ok) {
                    logToConsole(`连接成功 (${response.status})`, 'success');
                    updateStatus('连接测试成功', 'success');
                } else {
                    logToConsole(`连接失败 (${response.status})`, 'error');
                    updateStatus(`连接失败 (${response.status})`, 'error');
                }
            } catch (error) {
                logToConsole(`连接测试失败: ${error.message}`, 'error');
                updateStatus(`连接测试失败: ${error.message}`, 'error');
            }
        };

        window.playVideo = async function() {
            if (!player) {
                logToConsole('播放器未初始化', 'error');
                return;
            }

            try {
                await player.play();
                logToConsole('播放命令已发送', 'info');
            } catch (error) {
                logToConsole(`播放失败: ${error.message}`, 'error');
            }
        };

        window.pauseVideo = function() {
            if (!player) {
                logToConsole('播放器未初始化', 'error');
                return;
            }

            player.pause();
            logToConsole('暂停命令已发送', 'info');
        };

        window.stopVideo = function() {
            if (!player) {
                logToConsole('播放器未初始化', 'error');
                return;
            }

            player.pause();
            player.currentTime = 0;
            logToConsole('停止播放', 'info');
        };

        window.muteVideo = function() {
            if (!player) {
                logToConsole('播放器未初始化', 'error');
                return;
            }

            player.muted = !player.muted;
            logToConsole(`${player.muted ? '已静音' : '取消静音'}`, 'info');
        };

        window.getPlayerInfo = function() {
            if (!player) {
                logToConsole('播放器未初始化', 'error');
                return;
            }

            const info = {
                currentTime: player.currentTime,
                duration: player.duration,
                volume: player.volume,
                muted: player.muted,
                paused: player.paused,
                ended: player.ended,
                readyState: player.readyState,
                networkState: player.networkState
            };

            logToConsole('播放器信息:', 'info');
            Object.entries(info).forEach(([key, value]) => {
                logToConsole(`  ${key}: ${value}`, 'info');
            });
        };

        window.clearConsole = function() {
            document.getElementById('console').textContent = '';
        };

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('页面加载完成', 'success');
            updateStatus('页面已加载，请点击"更新播放器"开始', 'info');
        });
    </script>
</body>
</html>