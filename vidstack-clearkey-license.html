<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidstack ClearKey è®¸å¯è¯æœåŠ¡å™¨æ–¹å¼</title>
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css">
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        #player {
            width: 100%;
            height: 500px;
            margin: 20px 0;
            background: #000;
        }
        
        .config {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .log {
            background: #222;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .method {
            border: 1px solid #555;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .method h3 {
            margin-top: 0;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Vidstack ClearKey - è®¸å¯è¯æœåŠ¡å™¨æ–¹å¼</h1>
        
        <div class="config">
            <h2>å½“å‰é…ç½®</h2>
            <p><strong>MPD:</strong> https://qp-pldt-live-grp-05-prod.akamaized.net/out/u/cg_spotvhd.mpd</p>
            <p><strong>Key ID:</strong> ec7ee27d83764e4b845c48cca31c8eef</p>
            <p><strong>Key:</strong> 9c0e4191203fccb0fde34ee29999129e</p>
        </div>

        <div id="player"></div>
        
        <div class="config">
            <h2>æµ‹è¯•ä¸åŒçš„ DRM é…ç½®æ–¹æ³•</h2>
            <button onclick="testMethod1()">æ–¹æ³•1: Base64 Data URL</button>
            <button onclick="testMethod2()">æ–¹æ³•2: è‡ªå®šä¹‰è®¸å¯è¯å¤„ç†</button>
            <button onclick="testMethod3()">æ–¹æ³•3: Widevine æ¨¡æ‹Ÿ</button>
            <button onclick="testMethod4()">æ–¹æ³•4: æ—  DRM æµ‹è¯•</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="config">
            <div class="method">
                <h3>æ–¹æ³•è¯´æ˜:</h3>
                <p><strong>æ–¹æ³•1:</strong> ä½¿ç”¨ Base64 ç¼–ç çš„ Data URL ä½œä¸ºè®¸å¯è¯æœåŠ¡å™¨</p>
                <p><strong>æ–¹æ³•2:</strong> ä½¿ç”¨è‡ªå®šä¹‰è®¸å¯è¯è¯·æ±‚å¤„ç†å‡½æ•°</p>
                <p><strong>æ–¹æ³•3:</strong> å°è¯• Widevine DRM é…ç½®</p>
                <p><strong>æ–¹æ³•4:</strong> æµ‹è¯•ä¸ä½¿ç”¨ DRM æ˜¯å¦å¯ä»¥æ’­æ”¾</p>
            </div>
        </div>
        
        <div class="config">
            <h2>æ’­æ”¾æ—¥å¿—</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        import { VidstackPlayer, VidstackPlayerLayout } from 'https://cdn.vidstack.io/player.core';

        let currentPlayer = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function destroyCurrentPlayer() {
            if (currentPlayer) {
                try {
                    currentPlayer.destroy();
                } catch (e) {
                    log(`é”€æ¯æ’­æ”¾å™¨æ—¶å‡ºé”™: ${e.message}`);
                }
                currentPlayer = null;
            }
        }

        async function createPlayer(drmConfig, description) {
            try {
                log(`\n=== ${description} ===`);
                destroyCurrentPlayer();
                
                const layout = new VidstackPlayerLayout();
                
                const playerConfig = {
                    target: '#player',
                    viewType: 'video',
                    streamType: 'live',
                    logLevel: 'debug',
                    crossOrigin: true,
                    playsInline: true,
                    muted: true,
                    title: 'ClearKey DRM æµ‹è¯•',
                    src: 'https://qp-pldt-live-grp-05-prod.akamaized.net/out/u/cg_spotvhd.mpd',
                    layout,
                    autoPlay: false,
                    load: 'eager',
                    storage: null,
                    preferNativeHLS: false
                };

                if (drmConfig) {
                    playerConfig.drm = drmConfig;
                    log(`DRM é…ç½®: ${JSON.stringify(drmConfig, null, 2)}`);
                }

                log('æ­£åœ¨åˆ›å»ºæ’­æ”¾å™¨...');
                currentPlayer = await VidstackPlayer.create(playerConfig);
                
                setupEventListeners();
                log('æ’­æ”¾å™¨åˆ›å»ºæˆåŠŸ');

            } catch (error) {
                log(`æ’­æ”¾å™¨åˆ›å»ºå¤±è´¥: ${error.message}`);
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
        }

        function setupEventListeners() {
            if (!currentPlayer) return;

            currentPlayer.addEventListener('loadstart', () => log('ğŸ“¥ å¼€å§‹åŠ è½½'));
            currentPlayer.addEventListener('loadedmetadata', () => log('ğŸ“‹ å…ƒæ•°æ®å·²åŠ è½½'));
            currentPlayer.addEventListener('loadeddata', () => log('ğŸ“Š æ•°æ®å·²åŠ è½½'));
            currentPlayer.addEventListener('canplay', () => {
                log('âœ… å¯ä»¥æ’­æ”¾ - å°è¯•è‡ªåŠ¨æ’­æ”¾');
                currentPlayer.play().catch(err => log(`è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ${err.message}`));
            });
            
            currentPlayer.addEventListener('play', () => log('â–¶ï¸ å¼€å§‹æ’­æ”¾'));
            currentPlayer.addEventListener('playing', () => log('ğŸ¬ æ­£åœ¨æ’­æ”¾'));
            currentPlayer.addEventListener('pause', () => log('â¸ï¸ æ’­æ”¾æš‚åœ'));
            currentPlayer.addEventListener('waiting', () => log('â³ ç­‰å¾…ç¼“å†²'));
            currentPlayer.addEventListener('stalled', () => log('ğŸš« æ’­æ”¾åœæ»'));
            
            currentPlayer.addEventListener('encrypted', (e) => {
                log('ğŸ”’ æ£€æµ‹åˆ°åŠ å¯†åª’ä½“');
                console.log('åŠ å¯†è¯¦æƒ…:', e.detail);
            });
            
            currentPlayer.addEventListener('error', (e) => {
                log(`âŒ æ’­æ”¾å™¨é”™è¯¯: ${e.detail.message || JSON.stringify(e.detail)}`);
                console.error('é”™è¯¯è¯¦æƒ…:', e.detail);
            });
            
            currentPlayer.addEventListener('drm-error', (e) => {
                log(`ğŸ” DRM é”™è¯¯: ${e.detail.message || JSON.stringify(e.detail)}`);
                console.error('DRM é”™è¯¯è¯¦æƒ…:', e.detail);
            });
        }

        // æ–¹æ³•1: ä½¿ç”¨ Base64 ç¼–ç çš„ Data URL
        window.testMethod1 = async function() {
            const clearKeyLicense = {
                keys: [{
                    kty: "oct",
                    kid: "ec7ee27d83764e4b845c48cca31c8eef",
                    k: "9c0e4191203fccb0fde34ee29999129e"
                }]
            };
            
            const licenseBase64 = btoa(JSON.stringify(clearKeyLicense));
            const dataUrl = `data:application/json;base64,${licenseBase64}`;
            
            const drmConfig = {
                clearkey: {
                    licenseUrl: dataUrl
                }
            };

            await createPlayer(drmConfig, 'æ–¹æ³•1: Base64 Data URL');
        };

        // æ–¹æ³•2: ä½¿ç”¨è‡ªå®šä¹‰è®¸å¯è¯å¤„ç†
        window.testMethod2 = async function() {
            const drmConfig = {
                clearkey: {
                    licenseUrl: 'custom://clearkey-license',
                    licenseRequestHeaders: {
                        'Content-Type': 'application/json'
                    },
                    // è‡ªå®šä¹‰è®¸å¯è¯è¯·æ±‚å¤„ç†
                    onLicenseRequest: (request) => {
                        log('ğŸ”‘ å¤„ç†è®¸å¯è¯è¯·æ±‚');
                        
                        const clearKeyLicense = {
                            keys: [{
                                kty: "oct",
                                kid: "ec7ee27d83764e4b845c48cca31c8eef",
                                k: "9c0e4191203fccb0fde34ee29999129e"
                            }]
                        };
                        
                        return Promise.resolve(JSON.stringify(clearKeyLicense));
                    }
                }
            };

            await createPlayer(drmConfig, 'æ–¹æ³•2: è‡ªå®šä¹‰è®¸å¯è¯å¤„ç†');
        };

        // æ–¹æ³•3: å°è¯• Widevine é…ç½®
        window.testMethod3 = async function() {
            const drmConfig = {
                widevine: {
                    licenseUrl: 'data:application/json;base64,' + btoa(JSON.stringify({
                        keys: [{
                            kty: "oct",
                            kid: "ec7ee27d83764e4b845c48cca31c8eef",
                            k: "9c0e4191203fccb0fde34ee29999129e"
                        }]
                    }))
                }
            };

            await createPlayer(drmConfig, 'æ–¹æ³•3: Widevine æ¨¡æ‹Ÿ');
        };

        // æ–¹æ³•4: ä¸ä½¿ç”¨ DRM
        window.testMethod4 = async function() {
            await createPlayer(null, 'æ–¹æ³•4: æ—  DRM æµ‹è¯•');
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = '';
        };

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©ä¸€ä¸ªæ–¹æ³•è¿›è¡Œæµ‹è¯•');
        });
    </script>
</body>
</html>